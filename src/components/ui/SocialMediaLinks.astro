---
import { getLanguageFromUrl, t } from '../../utils';
import { getIcon } from '../../utils/images';

interface SocialLink {
  name: string;
  platform: string;
  url: string;
  icon: string;
  label: string;
  color?: string;
}

interface Props {
  links?: SocialLink[];
  layout?: 'horizontal' | 'vertical' | 'grid';
  size?: 'sm' | 'md' | 'lg';
  showLabels?: boolean;
  class?: string;
}

const lang = getLanguageFromUrl(Astro.url);

const defaultLinks: SocialLink[] = [
  {
    name: 'wechat',
    platform: 'wechat',
    url: '#wechat-qr',
    icon: getIcon('wechat'),
    label: t('social.wechat', lang),
    color: '#07C160'
  },
  {
    name: 'weibo',
    platform: 'weibo',
    url: 'https://weibo.com/u/7727126469',
    icon: getIcon('weibo'),
    label: t('social.weibo', lang),
    color: '#E6162D'
  },
  {
    name: 'tiktok',
    platform: 'tiktok',
    url: '#',
    icon: getIcon('tiktok'),
    label: t('social.tiktok', lang),
    color: '#000000'
  },
  {
    name: 'bilibili',
    platform: 'bilibili',
    url: 'https://space.bilibili.com/588632949?spm_id_from=333.1007.0.0',
    icon: getIcon('bilibili'),
    label: t('social.bilibili', lang),
    color: '#00A1D6'
  },
  {
    name: 'xiaohongshu',
    platform: 'xiaohongshu',
    url: 'https://www.xiaohongshu.com/user/profile/619dc3330000000021024542?xhsshare=WeixinSession&appuid=619dc3330000000021024542&apptime=1642477187',
    icon: getIcon('xiaohongshu'),
    label: t('social.xiaohongshu', lang),
    color: '#FF2442'
  }
];

const {
  links = defaultLinks,
  layout = 'horizontal',
  size = 'md',
  showLabels = true,
  class: className = ''
} = Astro.props;

const layoutClasses = {
  horizontal: 'flex flex-wrap items-center justify-center gap-6 lg:gap-8',
  vertical: 'flex flex-col gap-3',
  grid: 'grid grid-cols-2 sm:grid-cols-3 gap-4'
};

const sizeClasses = {
  sm: 'w-8 h-8',
  md: 'w-10 h-10',
  lg: 'w-12 h-12'
};

const textSizeClasses = {
  sm: 'text-sm',
  md: 'text-base',
  lg: 'text-lg'
};
---

<div class={`social-media-links ${layoutClasses[layout]} ${className}`}>
  {links.map((link) => (
    <a
      href={link.url}
      target={link.url.startsWith('#') ? undefined : '_blank'}
      rel={link.url.startsWith('#') ? undefined : 'noopener noreferrer'}
      class={`social-link social-link-${link.platform} group flex items-center gap-3 ${layout === 'horizontal' ? 'p-4 lg:p-6' : 'p-2'} rounded-xl transition-all duration-200 hover:shadow-lg ${layout === 'grid' ? 'justify-center' : ''} ${layout === 'horizontal' ? 'flex-col text-center min-w-[120px] lg:min-w-[140px]' : ''}`}
      aria-label={`${lang === 'zh' ? '访问' : 'Visit'} ${link.label}`}
      data-platform={link.platform}
      data-social-track={link.name}
    >
      <!-- Icon -->
      <div class={`social-icon ${sizeClasses[size]} flex-shrink-0 relative overflow-hidden rounded-lg`}>
        <img 
          src={link.icon}
          alt={link.label}
          class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-200"
          loading="lazy"
        />
        
        <!-- Hover overlay -->
        <div 
          class="absolute inset-0 opacity-0 group-hover:opacity-20 transition-opacity duration-200"
          style={`background-color: ${link.color || '#000'}`}
        ></div>
      </div>
      
      <!-- Label -->
      {showLabels && (
        <span class={`social-label ${textSizeClasses[size]} font-medium text-gray-700 group-hover:text-gray-900 transition-colors duration-200 ${layout === 'grid' || layout === 'horizontal' ? 'text-center' : ''} ${layout === 'horizontal' ? 'mt-2' : ''}`}>
          {link.label}
        </span>
      )}
      
      <!-- External link indicator -->
      {!link.url.startsWith('#') && layout !== 'horizontal' && (
        <svg class="w-3 h-3 text-gray-400 group-hover:text-gray-600 transition-colors duration-200 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
      )}
    </a>
  ))}
</div>

<style>
  .social-link {
    position: relative;
    background: white;
    border: 1px solid #e5e7eb;
  }
  
  .social-link:hover {
    border-color: #d1d5db;
    transform: translateY(-2px);
  }
  
  .social-media-links.horizontal .social-link {
    min-height: 120px;
  }
  
  @media (min-width: 1024px) {
    .social-media-links.horizontal .social-link {
      min-height: 140px;
    }
  }
  
  .social-link-wechat:hover {
    border-color: #07C160;
    box-shadow: 0 4px 12px rgba(7, 193, 96, 0.15);
  }
  
  .social-link-weibo:hover {
    border-color: #E6162D;
    box-shadow: 0 4px 12px rgba(230, 22, 45, 0.15);
  }
  
  .social-link-tiktok:hover {
    border-color: #000000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .social-link-bilibili:hover {
    border-color: #00A1D6;
    box-shadow: 0 4px 12px rgba(0, 161, 214, 0.15);
  }
  
  .social-link-xiaohongshu:hover {
    border-color: #FF2442;
    box-shadow: 0 4px 12px rgba(255, 36, 66, 0.15);
  }
  
  @media (max-width: 640px) {
    .social-media-links.grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<script>
  // 社交媒体点击追踪
  document.addEventListener('DOMContentLoaded', () => {
    const socialLinks = document.querySelectorAll('[data-social-track]');
    
    socialLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const platform = (e.currentTarget as HTMLElement).dataset.socialTrack;
        
        // 发送分析事件
        if (typeof gtag !== 'undefined') {
          gtag('event', 'social_click', {
            social_network: platform,
            social_action: 'click',
            social_target: (e.currentTarget as HTMLAnchorElement).href
          });
        }
        
        // 微信特殊处理 - 显示二维码
        if (platform === 'wechat') {
          e.preventDefault();
          showWeChatQR();
        }
      });
    });
  });
  
  // 显示微信二维码弹窗
  function showWeChatQR() {
    const modal = document.getElementById('wechat-qr-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  }
  
  // 关闭微信二维码弹窗
  function hideWeChatQR() {
    const modal = document.getElementById('wechat-qr-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
  }
  
  // 全局函数，供其他地方调用
  window.showWeChatQR = showWeChatQR;
  window.hideWeChatQR = hideWeChatQR;
</script>