---
/**
 * Events Page (English)
 * Displays all available events with filtering and pagination
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import EventsList from '../../components/sections/EventsList.astro';

import { sortEvents, filterEvents } from '../../utils/eventProcessing.js';
import type { ProcessedEvent, RawEvent } from '../../utils/eventProcessing.js';

// Load processed events data
let processedEvents: ProcessedEvent[] = [];
try {
  const eventsData = await import('../../data/events/processed-events.json');
  processedEvents = eventsData.default as ProcessedEvent[] || [];
} catch (error) {
  console.warn('Could not load processed events data:', error);
  // Fallback to raw events if processed events not available
  try {
    const rawEventsData = await import('../../../data/events/events.json');
    const { processEvents } = await import('../../utils/eventProcessing.js');
    processedEvents = processEvents(rawEventsData.default as RawEvent[] || []);
  } catch (fallbackError) {
    console.warn('Could not load raw events data:', fallbackError);
  }
}

// Get URL parameters for filtering and pagination
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get('page') || '1');
const statusFilter = url.searchParams.get('status') || 'all';
const tagFilter = url.searchParams.get('tag') || '';
const locationFilter = url.searchParams.get('location') || '';
const searchQuery = url.searchParams.get('q') || '';

// Apply filters
let filteredEvents = processedEvents;

if (statusFilter !== 'all') {
  filteredEvents = filterEvents(filteredEvents, {
    isUpcoming: statusFilter === 'upcoming'
  });
}

if (tagFilter) {
  filteredEvents = filterEvents(filteredEvents, {
    tags: [tagFilter]
  });
}

if (locationFilter) {
  filteredEvents = filterEvents(filteredEvents, {
    searchQuery: locationFilter // Use location as search query
  });
}

if (searchQuery) {
  filteredEvents = filterEvents(filteredEvents, {
    searchQuery
  });
}

// Sort events with status-based priority (upcoming first, then by sort field ascending)
const sortedEvents = sortEvents(filteredEvents, 'sort', 'asc');

// Load translations
const translations = await import('../../data/translations/en.json');
const t = translations.default;

// Page metadata
const pageTitle = 'Events - CNUserGroup';
const pageDescription = 'Discover upcoming and past events including tech talks, workshops, and community meetups.';

// Generate structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "CNUserGroup Events",
  "description": pageDescription,
  "numberOfItems": sortedEvents.length,
  "itemListElement": sortedEvents.slice(0, 10).map((event, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "item": {
      "@type": "Event",
      "name": event.title,
      "description": event.title,
      "startDate": event.time,
      "location": {
        "@type": "Place",
        "name": event.location
      },
      "url": event.url,
      "image": event.imageUrl,
      "organizer": {
        "@type": "Organization",
        "name": "CNUserGroup"
      }
    }
  }))
};
---

<BaseLayout 
  title={pageTitle}
  description={pageDescription}
>
  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
  
  <!-- Page Header -->
  <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="text-center">
        <h1 class="text-4xl font-bold mb-4">
          {t.events?.title || 'Events'}
        </h1>
        <p class="text-xl text-blue-100 max-w-3xl mx-auto">
          {t.events.description}
        </p>
        

      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-8" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-gray-500">
        <li>
          <a href={`${import.meta.env.BASE_URL}en`} class="hover:text-gray-700">Home</a>
        </li>
        <li>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
        </li>
        <li class="text-gray-900 font-medium">Events</li>
      </ol>
    </nav>

    <!-- Active Filters Display -->
    {(statusFilter !== 'all' || tagFilter || locationFilter || searchQuery) && (
      <div class="mb-6 p-4 bg-blue-50 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <span class="text-sm font-medium text-blue-800">{t.events.filters.activeFilters}:</span>
            <div class="flex flex-wrap gap-2">
              {statusFilter !== 'all' && (
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  {statusFilter === 'upcoming' ? t.events.upcomingEvents : t.events.pastEvents}
                </span>
              )}
              {tagFilter && (
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  Tag: {tagFilter}
                </span>
              )}
              {locationFilter && (
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  Location: {locationFilter}
                </span>
              )}
              {searchQuery && (
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  Search: {searchQuery}
                </span>
              )}
            </div>
          </div>
          <a
            href={`${import.meta.env.BASE_URL}en/events`}
            class="text-sm text-blue-600 hover:text-blue-800 font-medium"
          >
            {t.events.filters.clearFilters}
          </a>
        </div>
      </div>
    )}



    <!-- Events List -->
    <EventsList
      events={sortedEvents}
      locale="en"
      showEngagement={true}
      showFilters={true}
      showPagination={true}
      eventsPerPage={12}
      currentPage={currentPage}
      totalEvents={sortedEvents.length}
      totalPages={Math.ceil(sortedEvents.length / 12)}
      allEvents={sortedEvents}
    />

    <!-- Call to Action -->
    {sortedEvents.length > 0 && (
      <div class="mt-16 bg-gray-50 rounded-lg p-8 text-center">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">
          {t.events.cta.learnMore}
        </h2>
        <p class="text-gray-600 mb-6">
          {t.events.cta.followUs}
        </p>
        <div class="flex justify-center space-x-4">
          <a
            href={`${import.meta.env.BASE_URL}en/about#contact`}
            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            {t.events.cta.contactUs}
          </a>
          <a
            href={`${import.meta.env.BASE_URL}en/cities`}
            class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            {t.events.cta.viewCities}
          </a>
        </div>
      </div>
    )}
  </main>
</BaseLayout>



<style>
  /* Custom styles for better mobile experience */
  @media (max-width: 640px) {
    .events-list {
      padding: 0 1rem;
    }
  }
</style>