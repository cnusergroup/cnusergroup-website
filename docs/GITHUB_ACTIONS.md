# GitHub Actions 自动化部署

本项目使用 GitHub Actions 实现完全自动化的数据抓取、构建和部署流程。

## 工作流概述

### 1. 主部署工作流 (`.github/workflows/deploy.yml`)

**触发条件：**
- 推送到 `main` 分支
- 每天早上 8 点定时执行
- 手动触发

**执行步骤：**
1. **环境准备**
   - 检出代码
   - 设置 Node.js 20
   - 安装依赖
   - 安装 Playwright（用于网页抓取）

2. **数据抓取**
   - 清空上次抓取的活动数据（图片文件保留）
   - 从官方网站重新抓取最新活动数据
   - 数据验证和清洗
   - 自动提交更新的数据

4. **构建部署**
   - 运行部署准备脚本
   - 构建 Astro 项目
   - 验证构建输出
   - 部署到 GitHub Pages

### 2. 数据更新工作流 (`.github/workflows/update-data.yml`)

**触发条件：**
- 每天早上 8 点和晚上 8 点
- 手动触发

**执行步骤：**
1. 清空上次的活动数据
2. 抓取最新活动数据
3. 验证数据完整性
4. 提交数据更新
5. 自动触发主部署工作流

## 手动触发选项

### 主部署工作流
- `force_scrape`: 强制重新抓取所有数据
- `skip_cache`: 跳过缓存，重新安装依赖

### 数据更新工作流
- `force_full_scrape`: 强制完整抓取（而非增量）

## 环境变量

可以在 GitHub 仓库设置中配置以下环境变量：

- `CUSTOM_DOMAIN`: 自定义域名（可选）
- `FORCE_EVENT_SCRAPING`: 强制事件抓取

## 脚本说明

### `scripts/build-ci.js`
专为 CI 环境优化的构建脚本：
- 简化的验证流程
- 更好的错误处理
- 适合自动化环境

### `scripts/deploy-ready.js`
支持 `--skip-events` 参数，跳过事件处理（当在 CI 中已完成时）

## 监控和调试

### 查看工作流状态
1. 进入 GitHub 仓库
2. 点击 "Actions" 标签
3. 查看最近的工作流运行

### 常见问题

**数据抓取失败**
- 工作流会自动使用现有数据继续构建
- 不会因为抓取失败而阻止部署

**构建失败**
- 检查 Actions 日志中的错误信息
- 验证数据文件格式是否正确

**部署失败**
- 确保 GitHub Pages 已启用
- 检查仓库权限设置

## 本地开发

本地开发时仍可使用原有命令：

```bash
# 本地构建
npm run build

# 本地开发服务器
npm run dev

# 清空活动数据
npm run clear:events

# 手动抓取数据
npm run scrape:events

# 清空并重新抓取（推荐）
npm run scrape:fresh

# 部署准备
npm run deploy:ready
```

## 优势

1. **完全自动化**: 无需手动干预，数据和部署全自动
2. **定时更新**: 每天自动抓取最新数据
3. **错误恢复**: 抓取失败时自动使用现有数据
4. **灵活控制**: 支持手动触发和参数控制
5. **快速部署**: 优化的 CI 构建流程
6. **数据一致性**: 自动提交数据更新，保持版本同步

## 部署流程图

```
推送代码/定时触发
       ↓
   环境准备
       ↓
   数据抓取 → 验证 → 提交
       ↓
   项目构建
       ↓
   部署验证
       ↓
  GitHub Pages
```

这样的设置让你的网站能够：
- 自动获取最新的活动数据
- 自动构建和部署
- 保持数据的实时性
- 减少手动维护工作