name: Update Event Data

on:
  # æ¯å¤©å‡Œæ™¨2ç‚¹å’Œä¸‹åˆ2ç‚¹æ›´æ–°æ•°æ®
  schedule:
    - cron: '0 18,6 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_full_scrape:
        description: 'å¼ºåˆ¶å®Œæ•´æŠ“å–'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Setup Playwright
        run: |
          npx playwright install chromium
          npx playwright install-deps chromium
        
      - name: Clear previous event data
        run: |
          echo "ğŸ§¹ æ¸…ç©ºä¸Šæ¬¡çš„æ´»åŠ¨æ•°æ®..."
          
          # æ¸…ç©ºäº‹ä»¶æ•°æ®
          mkdir -p src/data/events
          echo "[]" > src/data/events/processed-events.json
          echo "{}" > src/data/events/city-mappings.json
          echo '{"totalEvents":0,"lastUpdated":"'$(date -u +"%Y-%m-%dT%H:%M:%S.%3NZ")'","status":"cleared"}' > src/data/events/event-stats.json
          
          if [ -f "data/events/events.json" ]; then
            echo "[]" > data/events/events.json
          fi
          
          echo "âœ… æ´»åŠ¨æ•°æ®å·²æ¸…ç©ºï¼Œå‡†å¤‡é‡æ–°æŠ“å–"
          
      - name: Scrape event data
        run: |
          echo "ğŸ•·ï¸ å¼€å§‹æŠ“å–æœ€æ–°æ´»åŠ¨æ•°æ®..."
          
          # è®¾ç½®æŠ“å–æ¨¡å¼
          if [ "${{ github.event.inputs.force_full_scrape }}" = "true" ]; then
            echo "ğŸ”„ æ‰§è¡Œå¼ºåˆ¶å®Œæ•´æ•°æ®æŠ“å–"
            npm run scrape:events:force
          else
            echo "ğŸ”„ æ‰§è¡Œæ ‡å‡†æ•°æ®æŠ“å–ï¼ˆåˆ†é¡µæŠ“å–ï¼‰"
            npm run scrape:events
          fi
          
          # éªŒè¯æŠ“å–ç»“æœ
          if [ -f "data/events/events.json" ]; then
            event_count=$(jq length data/events/events.json 2>/dev/null || echo "0")
            echo "ğŸ“Š æŠ“å–åˆ° $event_count ä¸ªåŸå§‹äº‹ä»¶"
          else
            echo "âŒ æŠ“å–å¤±è´¥ï¼Œæœªç”ŸæˆåŸå§‹æ•°æ®æ–‡ä»¶"
            exit 1
          fi
        env:
          CI: true
        timeout-minutes: 15
          
      - name: Process event data
        run: |
          echo "âš™ï¸ å¤„ç†äº‹ä»¶æ•°æ®..."
          
          # è¿è¡Œäº‹ä»¶æ•°æ®å¤„ç†è„šæœ¬
          if [ -f "data/events/events.json" ]; then
            echo "ğŸ“Š å¼€å§‹å¤„ç†åŸå§‹äº‹ä»¶æ•°æ®"
            node scripts/process-events.js --force
            
            # éªŒè¯å¤„ç†ç»“æœ
            if [ -f "src/data/events/processed-events.json" ]; then
              processed_count=$(jq length src/data/events/processed-events.json 2>/dev/null || echo "0")
              echo "âœ… å¤„ç†å®Œæˆï¼Œç”Ÿæˆ $processed_count ä¸ªå¤„ç†åçš„äº‹ä»¶"
            else
              echo "âŒ äº‹ä»¶å¤„ç†å¤±è´¥ï¼Œæœªç”Ÿæˆå¤„ç†åçš„æ•°æ®"
              exit 1
            fi
          else
            echo "âŒ æ²¡æœ‰åŸå§‹äº‹ä»¶æ•°æ®ï¼Œæ— æ³•å¤„ç†"
            exit 1
          fi
        env:
          NODE_ENV: production
          CI: true
        timeout-minutes: 10
          
      - name: Validate data
        run: |
          echo "ğŸ” éªŒè¯æ•°æ®å®Œæ•´æ€§..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ -f "src/data/events/processed-events.json" ]; then
            event_count=$(jq length src/data/events/processed-events.json)
            echo "ğŸ“Š å½“å‰äº‹ä»¶æ•°é‡: $event_count"
            
            if [ $event_count -eq 0 ]; then
              echo "âš ï¸ æ²¡æœ‰äº‹ä»¶æ•°æ®ï¼Œå¯èƒ½æŠ“å–å¤±è´¥"
              exit 1
            fi
          else
            echo "âŒ äº‹ä»¶æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet src/data/events/; then
            echo "ğŸ“ æ²¡æœ‰æ•°æ®æ›´æ–°"
          else
            echo "ğŸ“ å‘ç°æ•°æ®æ›´æ–°ï¼Œæäº¤æ›´æ”¹"
            
            # æ˜¾ç¤ºæ›´æ”¹ç»Ÿè®¡
            echo "ğŸ“Š æ›´æ”¹ç»Ÿè®¡:"
            git diff --stat src/data/events/
            
            git add src/data/events/
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°äº‹ä»¶æ•°æ® $(date -u +"%Y-%m-%d %H:%M UTC")"
            git push
            
            echo "âœ… æ•°æ®æ›´æ–°å·²æäº¤"
          fi
          
      - name: Trigger deployment
        if: success()
        run: |
          # å¦‚æœæœ‰æ•°æ®æ›´æ–°ï¼Œè§¦å‘éƒ¨ç½²å·¥ä½œæµ
          if ! git diff --quiet HEAD~1 src/data/events/; then
            echo "ğŸš€ æ•°æ®å·²æ›´æ–°ï¼Œå°†è§¦å‘ç½‘ç«™é‡æ–°éƒ¨ç½²"
            # GitHub Actions ä¼šè‡ªåŠ¨è§¦å‘ deploy.ymlï¼ˆå› ä¸ºæ¨é€åˆ° main åˆ†æ”¯ï¼‰
          fi